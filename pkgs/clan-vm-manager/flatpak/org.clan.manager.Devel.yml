id: org.clan.manager.Devel
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: clan-vm-manager
modules:
  - name: clan-vm-manager
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app ./pkgs/clan-vm-manager
    build-options:
     build-args:
      - --share=network
    sources:
      - type: dir
        path: ../../../
  - name: clan-cli
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app --no-build-isolation --no-deps ./pkgs/clan-cli
    build-options:
     build-args:
      - --share=network
    sources:
      - type: dir
        path: ../../../
finish-args:
  - "--share=network"
  - "--filesystem=host"
  - "--filesystem=host-etc"
  - "--filesystem=/run/current-system/sw/bin/nix"
  - "--filesystem=/run/opengl-driver/"
  - "--filesystem=/nix/store/"
  - "--filesystem=xdg-config/sops"
  - "--filesystem=xdg-run/qemu"
  - "--filesystem=/tmp:rw"
  - "--filesystem=/tmp/org.clan.cli/:create"
  - "--env=TMPDIR=/tmp/org.clan.cli/"
  - "--device=all"
  - "--allow=multiarch"
  - "--allow=devel"
  # - "--filesystem=/dev/vsock"
  - "--env=PATH=/app/bin:/run/current-system/sw/bin"
  - "--share=ipc"
  # - "--unshare=ipc"
  - "--socket=fallback-x11"
  - "--socket=wayland"
  - "--socket=pulseaudio"
  - "--socket=system-bus"
  - "--socket=session-bus"
  - "--filesystem=xdg-run/gvfs"
  - "--filesystem=xdg-run/gvfsd"
  - "--filesystem=xdg-run/pipewire-0:rw"
  - "--talk-name=org.clan.cli"
  - "--system-talk-name=org.freedesktop.UDisks2"
  - "--filesystem=xdg-run/dconf"
  - "--filesystem=~/.config/dconf:ro"
  - "--talk-name=ca.desrt.dconf"
  - "--env=GIO_EXTRA_MODULES=/app/lib/gio/modules/"
